{% extends 'construccion1app/base.html' %}

{% block contenido %}
{% load crispy_forms_tags %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .chart-container {
        position: relative;
        height: 320px;
        max-width: 380px;
        margin: 0 auto;
    }
    .chart-container canvas {
        width: 100% !important;
        height: auto !important;
    }
    .chart-center-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: 700;
        font-size: 2rem;
        color: #28a745;
    }
    .badge-estado {
        padding: .35rem .6rem;
        border-radius: .5rem;
        font-weight: 600;
        font-size: .9rem;
    }

    /* Mapeo de colores para badges de estado */
    .badge.estado-no_ejecutada { 
        background-color: #6c757d !important; 
        color: #fff !important; 
    }
    .badge.estado-ejecutada { 
        background-color: #0d6efd !important; 
        color: #fff !important; 
    }
    .badge.estado-revisada { 
        background-color: #198754 !important; 
        color: #fff !important; 
    }
    .badge.estado-observada { 
        background-color: #dc3545 !important; 
        color: #fff !important; 
    } 
    .badge.estado-ejecucion, 
    .badge.estado-en_ejecucion { 
        background-color: #ffc107 !important; 
        color: #000 !important; 
    }
    .btn-orange {
    background-color: #ff7a00 !important;
    color: white !important;
    border-color: #ff7a00 !important;
    }
    .btn-orange:hover {
        background-color: #e96f00 !important;
        border-color: #e96f00 !important;
    }

</style>
<style>
    /* Asegurar que el PDF ocupe todo el espacio */
    .modal-body iframe {
        min-height: 70vh;
    }
    
    /* En móviles, altura completa */
    @media (max-width: 767.98px) {
        .modal-body iframe {
            min-height: calc(100vh - 150px);
        }
    }
</style>
{% if messages %}
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1080;">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-lg rounded-3 d-flex align-items-center custom-alert-{{ message.tags }}" 
           role="alert" style="min-width: 320px; animation: slideIn 0.5s ease;">
        
        {% if message.tags == "success" %}
          <i class="bi bi-check-circle-fill me-2 fs-4"></i>
        {% elif message.tags == "error" %}
          <i class="bi bi-x-circle-fill me-2 fs-4"></i>
        {% elif message.tags == "warning" %}
          <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
        {% elif message.tags == "info" %}
          <i class="bi bi-info-circle-fill me-2 fs-4"></i>
        {% endif %}

        <div class="flex-grow-1">
          {{ message }}
        </div>
        <button type="button" class="btn-close ms-2" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<style>
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Colores personalizados */
.custom-alert-success {
  background: linear-gradient(135deg, #28a745, #218838);
  color: #fff;
}
.custom-alert-success i { color: #fff; }

.custom-alert-error {
  background: linear-gradient(135deg, #dc3545, #b02a37);
  color: #fff;
}
.custom-alert-error i { color: #fff; }

.custom-alert-warning {
  background: linear-gradient(135deg, #ffc107, #e0a800);
  color: #212529;
}
.custom-alert-warning i { color: #856404; }

.custom-alert-info {
  background: linear-gradient(135deg, #17a2b8, #117a8b);
  color: #fff;
}
.custom-alert-info i { color: #fff; }
</style>

<a href="{% url 'mis_proyectos' %}" class="btn btn-light shadow-sm" style="border: 2px solid #e0e0e0; font-weight: 500;">
    <i class="fas fa-arrow-left me-2"></i>Volver a Proyectos
</a>
<br>

<div class="container-fluid">
    <div class="card p-4 shadow-sm">
        <h1 class="mb-3 text-center">{{ proyecto.nombre }}</h1>
        
        {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' %}
        <div class="text-center mb-4">
            <form action="{% url 'eliminar_proyecto' proyecto.id %}" method="post" 
                  onsubmit="return confirm('¿Estás seguro de que quieres eliminar este proyecto? Esta acción no se puede deshacer.');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-lg shadow-sm">
                    <i class="bi bi-trash"></i> 
                </button>
            </form>
        </div>
        {% endif %}

        {% if request.user.is_superuser or request.user.tipo_usuario in 'superadmin_empresa,admin_empresa' %}
            {% if mostrar_formulario %}
                <div class="text-center mb-4">
                    <button class="btn btn-primary btn-lg shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#formAgregarNivel" aria-expanded="false" aria-controls="formAgregarNivel">
                        <i class="bi bi-plus-circle"></i> Crear Nivel
                    </button>
                </div>
 
                <div class="collapse" id="formAgregarNivel">
                    <div class="card card-body">
                        <form method="post">
                            {% csrf_token %}
                            {{ form|crispy }}
                            <div class="d-grid mt-3">
                                <button type="submit" class="btn btn-success">Crear Nivel</button>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}
        {% endif %}

        <script>
        document.addEventListener("DOMContentLoaded", function () {
            const incidenciaInput = document.querySelector("#id_incidencia");
            const alerta = document.createElement("div");
            alerta.classList.add("text-danger", "mt-2");
            incidenciaInput.parentNode.appendChild(alerta);

            const form = incidenciaInput.closest("form");
            let excedido = false;

            incidenciaInput.addEventListener("input", function () {
                const valor = parseInt(this.value) || 0;

                fetch("{% url 'sumar_incidencias' proyecto.id %}")
                    .then(response => response.json())
                    .then(data => {
                        const sumaExistente = data.suma || 0;
                        if (sumaExistente + valor > 100) {
                            alerta.innerText = `⚠️ La suma supera 100 (actual: ${sumaExistente}, digitaste ${valor}).`;
                            excedido = true;
                        } else {
                            alerta.innerText = "";
                            excedido = false;
                        }
                    });
            });

            form.addEventListener("submit", function (e) {
                if (excedido) {
                    e.preventDefault();
                    alert("No puedes guardar el nivel: la suma de incidencias supera 100.");
                }
            });
        });
        </script>

        <!-- Gráfico principal -->
        <div class="chart-container">
            <canvas id="progresoProyecto"></canvas>
            <div class="chart-center-text">{{ avance_total|floatformat:2 }}%</div>
        </div>

        <hr class="my-4">

        {% for nivel in niveles %}
        <div class="nivel-card mb-4">
            <!-- Header del nivel con botón Ver Espacios -->
            <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                <h4 class="mb-2">{{ nivel.nombre }}</h4>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="badge bg-success badge-custom">Avance: {{ nivel.avance|floatformat:2 }}%</span>
                    
                    {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' %}
                        <span class="badge bg-primary badge-custom">Incidencia: {{ nivel.incidencia|floatformat:2 }}%</span>
                        <span class="badge bg-warning text-dark badge-custom">Ponderado: {{ nivel.ponderado|floatformat:2 }}%</span>
                        <form action="{% url 'eliminar_nivel' nivel.id %}" method="post" class="d-inline"
                            onsubmit="return confirm('¿Estás seguro de que quieres eliminar este nivel? Esta acción no se puede deshacer.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger me-1">
                                <i class="bi bi-trash"></i> 
                            </button>
                        </form>
                        <a href="{% url 'agregar_espacio' nivel.id %}" class="btn btn-sm btn-success">Agregar Espacio</a>
                    {% endif %}

                    {% if request.user.tipo_usuario == 'admin_empresa' %}
                        <a href="{% url 'agregar_espacio' nivel.id %}" class="btn btn-sm btn-success">Agregar Espacio</a>
                    {% endif %}

                    <!-- Botón Ver Espacios -->
                    <button class="btn btn-sm btn-outline-info toggle-espacios" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#espacios-nivel-{{ nivel.id }}">
                        <i class="bi bi-eye"></i> Ver Espacios
                    </button>
                </div>
            </div>

            <div class="progress mb-3">
                <div class="progress-bar bg-success progress-bar-striped nivel-progress-bar-{{ nivel.id }}" 
                    role="progressbar" 
                    data-avance="{{ nivel.avance }}"
                    aria-valuenow="{{ nivel.avance|floatformat:2 }}" 
                    aria-valuemin="0" 
                    aria-valuemax="100"
                    style="width: 0%;">
                    {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' %}
                        {{ nivel.avance|floatformat:2 }}%
                    {% endif %}
                </div>
            </div>
            <!-- Sección de Espacios Colapsable -->
            <div class="collapse show" id="espacios-nivel-{{ nivel.id }}">
                <h5 class="mb-3">Espacios</h5>
                <div class="row">
                    {% for e in nivel.espacios %}
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card espacio-card mb-3 p-3 shadow-sm position-relative">
                            <strong class="d-block mb-2">{{ e.nombre }}</strong>

                            {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' %}
                                <form action="{% url 'eliminar_espacio' e.id %}" method="post" class="position-absolute top-0 end-0 m-2"
                                    onsubmit="return confirm('¿Estás seguro de que quieres eliminar este espacio? Esta acción no se puede deshacer.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            {% endif %}

                            {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' %}
                                <span class="badge bg-primary badge-custom">
                                    Incidencia: {{ e.incidencia|floatformat:2 }}%
                                </span><br>
                            {% endif %}

                            <!-- Gráfico de Avance -->
                            <div class="d-flex justify-content-center mt-3">
                                <canvas id="avance-chart-{{ e.id }}" style="max-width: 120px; max-height: 120px;"></canvas>
                                <div class="fw-bold text-center mt-2">
                                    {{ e.avance|floatformat:2 }}%
                                </div>
                            </div>

                            <!-- Botón Ver Actividades -->
                            <button class="btn btn-sm btn-outline-primary mt-3 w-100 toggle-actividades" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#actividades-{{ e.id }}">
                                <i class="bi bi-eye"></i> Ver Actividades
                            </button>

                            <!-- Tabla actividades colapsable -->
                            <div class="collapse mt-3" id="actividades-{{ e.id }}">
                                {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' or request.user.tipo_usuario == 'admin_empresa' %}
                                    {% if e.total_incidencia < 100 %}
                                        <a href="{% url 'agregar_actividad' e.id %}" class="btn btn-success btn-lg shadow-sm" title="Agregar Actividad">
                                            <i class="bi bi-plus-circle"></i>
                                        </a>
                                        {% if e.total_incidencia == 0 %}
                                        <button type="button" 
                                                class="btn btn-warning btn-lg shadow-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#importarModal-{{ e.id }}">
                                            <i class="bi bi-file-earmark-excel"></i>
                                        </button>
                                        <a href="{% url 'descargar_plantilla_actividades' e.id %}"
                                        class="btn btn-orange btn-lg shadow-sm"
                                        title="Descargar Plantilla Excel">
                                            <i class="bi bi-download"></i>
                                        </a>

                                        {% endif %}
                                        {% include 'construccion1app/importar_actividades.html' with espacio=e %}
                                    {% else %}
                                        <button type="button" class="btn btn-success btn-lg shadow-sm"
                                                onclick="alert('No puedes agregar más actividades, ya que la suma de incidencias ya es 100.');">
                                            <i class="bi bi-plus-circle"></i>
                                        </button>
                                    {% endif %}

                                    <button type="button" 
                                            class="btn btn-info btn-lg shadow-sm" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#mapaModal-{{ e.id }}">
                                        <i class="bi bi-diagram-3"></i>
                                    </button>

                                    <!-- Modal Mapa -->
                                    <div class="modal fade" id="mapaModal-{{ e.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-xl modal-dialog-centered">
                                            <div class="modal-content rounded-4 shadow-lg">
                                                <div class="modal-header bg-primary text-white">
                                                    <h5 class="modal-title">Mapa de Actividades</h5>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div id="network-{{ e.id }}" style="height: 600px;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- Tabla de actividades -->
                                <div class="table-responsive">
                                    <br>
                                    <table class="table table-borderless align-middle text-center shadow-sm rounded table-primary">
                                        <thead class="table-dark">
                                            <tr>  
                                                <th class="text-center" style="width: 50px;">#</th>
                                                <th class="text-start">Actividad</th>
                                                <th class="text-start">Info</th>
                                                <th>Avance</th>
                                                {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' or request.user.tipo_usuario == 'admin_empresa' %}
                                                    <th>Incidencia</th>
                                                    <th>Ponderado</th>
                                                {% endif %}
                                                <th>Acciones</th>
                                                <th>Estado Ejecución</th>
                                                <th>Asignado</th>
                                                <th>Justificación</th>
                                                <th>Predecesora</th>
                                                <th>Sucesora</th>
                                                <th>Estado</th>
                                                <th>Estado Asignación</th>
                                                <th>Fecha Inicio</th>
                                                <th>Fecha Fin</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for a in e.actividades %}
                                            <tr class="hover-row" id="actividad-{{ a.id }}">
                                                <td class="text-center fw-bold" style="color: #667eea;">{{ forloop.counter }}</td>
                                                <td class="text-start fw-semibold">{{ a.nombre }}</td>
                                                <td class="text-center">
        {% if a.archivo_informacion %}
            {% load cloudinary %}
            
            <!-- Botón que abre el modal -->
            <a href="#" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#pdfModal{{ forloop.counter }}">
                <i class="fas fa-file-pdf"></i> Ver PDF
            </a>
            
            <!-- Modal para mostrar el PDF -->
            <div class="modal fade" id="pdfModal{{ forloop.counter }}" tabindex="-1" aria-labelledby="pdfModalLabel{{ forloop.counter }}" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="pdfModalLabel{{ forloop.counter }}">
                                Visualizador de PDF
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body p-0">
                            <!-- Contenedor para PDF -->
                            <div id="pdf-container-{{ forloop.counter }}" class="pdf-container">
                                <!-- Usar Google Docs Viewer como fallback -->
                                <iframe src="https://docs.google.com/viewer?url={{ a.archivo_informacion.url|urlencode }}&embedded=true" 
                                        style="width: 100%; height: 75vh; border: none;"
                                        onerror="this.src='{{ a.archivo_informacion.url }}'">
                                </iframe>
                            </div>
                            
                            <!-- Mensaje alternativo para iOS -->
                            <div id="ios-message-{{ forloop.counter }}" class="d-none text-center p-4" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                                <i class="fas fa-mobile-alt fa-3x text-primary mb-3"></i>
                                <h5>Visualización en iPhone</h5>
                                <p class="mb-3">Para una mejor experiencia, utiliza las opciones de descarga o abrir en nueva pestaña.</p>
                                <div class="d-flex justify-content-center gap-2">
                                    <a href="{{ a.archivo_informacion.url }}" target="_blank" class="btn btn-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>Abrir
                                    </a>
                                    <a href="{{ a.archivo_informacion.url }}" download class="btn btn-success">
                                        <i class="fas fa-download me-1"></i>Descargar
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="{{ a.archivo_informacion.url }}" target="_blank" class="btn btn-secondary" download>
                                <i class="fas fa-download"></i> Descargar PDF
                            </a>
                            <a href="{{ a.archivo_informacion.url }}" target="_blank" class="btn btn-info">
                                <i class="fas fa-external-link-alt"></i> Abrir en nueva pestaña
                            </a>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </td>
                                                <td>
                                                    <div class="progress" style="height: 18px; border-radius: 8px; position: relative;">
                                                        <div class="progress-bar {% if a.avance >= 75 %}{% elif a.avance >= 40 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                             style="width: {% if a.avance <= 0 or a.avance >= 100 %}100%{% else %}{{ a.avance }}%{% endif %}; background-color: {% if a.avance >= 75 %}#28a745{% endif %} !important;">
                                                        </div>
                                                        <span style="position: absolute; width: 100%; text-align: center; line-height: 18px; font-weight: 500; color: {% if a.avance >= 40 and a.avance < 75 %}#212529{% else %}#ffffff{% endif %};">
                                                            {{ a.avance|floatformat:0 }}%
                                                        </span>
                                                    </div>
                                                </td>
                                                {% if request.user.is_superuser or request.user.tipo_usuario in 'superadmin_empresa admin_empresa' %}
                                                    <td><span class="badge bg-primary rounded-pill">{{ a.incidencia|floatformat:2 }}%</span></td>
                                                    <td><span class="badge bg-warning text-dark rounded-pill">{{ a.ponderado|floatformat:2 }}%</span></td>
                                                {% endif %}
                                                <td>
                                                    {% if request.user.is_superuser or request.user.tipo_usuario in 'superadmin_empresa admin_empresa calidad' or a.asignado == request.user %}
                                                        <a href="{% url 'modificar_actividad' a.id %}" class="btn btn-outline-primary btn-sm">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </a>
                                                        {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' %}
                                                            <form action="{% url 'eliminar_actividad' a.id %}" method="post" class="d-inline" onsubmit="return confirm('¿Estás seguro?');">
                                                                {% csrf_token %}
                                                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </form>
                                                        {% endif %}
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge estado-{{ a.estado_ejecucion|lower }}">
                                                        {{ a.estado_ejecucion }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if a.asignado %}
                                                        <span class="badge bg-warning text-dark rounded-pill">{{ a.asignado }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">No asignado</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if a.justificacion %}
                                                        <span class="badge bg-info text-dark">Hubo justificación</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">Sin justificación</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if a.predecesora %}
                                                        <span class="badge bg-primary">{{ a.predecesora }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">No definido</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if a.sucesora %}
                                                        <span class="badge bg-primary">{{ a.sucesora }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">No definido</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if a.habilitada %}
                                                        <span class="badge bg-success">Habilitada</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">No habilitada</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if a.estado_asignacion == "ASIGNADA" %}
                                                        <span class="badge bg-success">Asignada</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">Sin asignar</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ a.fecha_inicio|date:"d/m/Y" }}</td>
                                                <td>{{ a.fecha_fin|date:"d/m/Y" }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="13" class="text-muted fst-italic">No hay actividades registradas</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<script>
// Toggle para botones "Ver Espacios"
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.toggle-espacios').forEach(function (btn) {
        const targetId = btn.getAttribute('data-bs-target');
        const target = document.querySelector(targetId);

        target.addEventListener('show.bs.collapse', function () {
            btn.innerHTML = '<i class="bi bi-eye-slash"></i> Ocultar Espacios';
        });

        target.addEventListener('hide.bs.collapse', function () {
            btn.innerHTML = '<i class="bi bi-eye"></i> Ver Espacios';
        });
    });

    // Toggle para botones "Ver Actividades"
    document.querySelectorAll('.toggle-actividades').forEach(function (btn) {
        const targetId = btn.getAttribute('data-bs-target');
        const target = document.querySelector(targetId);

        target.addEventListener('show.bs.collapse', function () {
            btn.innerHTML = '<i class="bi bi-eye-slash"></i> Ocultar Actividades';
        });

        target.addEventListener('hide.bs.collapse', function () {
            btn.innerHTML = '<i class="bi bi-eye"></i> Ver Actividades';
        });
    });
});

// Gráfico principal
document.addEventListener("DOMContentLoaded", function () {
    const canvas = document.getElementById("progresoProyecto");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    const avance = parseFloat("{{ avance_total|default:0 }}");

    if (window.progresoProyectoChart) {
        window.progresoProyectoChart.destroy();
    }

    window.progresoProyectoChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Completado', 'Pendiente'],
            datasets: [{
                data: [avance, 100 - avance],
                backgroundColor: ['#28a745', '#e9ecef'],
                borderColor: '#ffffff',
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw.toFixed(2)}%`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                duration: 1200
            }
        }
    });
});

// Gráficos de avance por espacio
document.addEventListener("DOMContentLoaded", function () {
    {% for nivel in niveles %}
        {% for e in nivel.espacios %}
        (function() {
            var canvas = document.getElementById('avance-chart-{{ e.id }}');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            var avanceRaw = "{{ e.avance|default_if_none:'0'|floatformat:2 }}";
            var avance = parseFloat(avanceRaw.replace(',', '.'));
            if (isNaN(avance)) avance = 0;
            var restante = 100 - avance;
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Avance', 'Restante'],
                    datasets: [{
                        data: [avance, restante],
                        backgroundColor: [
                            'rgba(13, 110, 253, 0.85)',
                            'rgba(233, 236, 239, 0.6)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: { legend: { display: false } },
                    responsive: false,
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        duration: 1000
                    }
                }
            });
        })();
        {% endfor %}
    {% endfor %}
});

// Mapa de actividades
document.addEventListener("DOMContentLoaded", function () {
    {% for nivel in niveles %}
        {% for e in nivel.espacios %}
        const modalEl{{ e.id }} = document.getElementById("mapaModal-{{ e.id }}");
        if (modalEl{{ e.id }}) {
            modalEl{{ e.id }}.addEventListener("shown.bs.modal", function () {
                fetch("{% url 'mapa_actividades' e.id %}")
                    .then(response => response.json())
                    .then(data => {
                        const nodes = new vis.DataSet(
                            data.nodes.map(n => ({
                                id: n.id,
                                label: n.label,
                                shape: "box",
                                color: n.estado === "ejecutada" ? "#28a745" : 
                                       n.estado === "observada" ? "#ffc107" : "#0d6efd",
                                font: { color: "#fff", size: 16, face: "Arial", bold: true },
                                margin: 10
                            }))
                        );

                        const edges = new vis.DataSet(
                            data.edges.map(e => ({
                                from: e.from,
                                to: e.to,
                                arrows: "to",
                                color: { color: "#6c757d" }
                            }))
                        );

                        const container = document.getElementById("network-{{ e.id }}");

                        const options = {
                            layout: {
                                hierarchical: {
                                    enabled: true,
                                    direction: "LR",
                                    sortMethod: "directed"
                                }
                            },
                            edges: { smooth: true },
                            physics: false,
                            interaction: {
                                dragNodes: true,
                                zoomView: true,
                                dragView: true
                            }
                        };

                        new vis.Network(container, { nodes, edges }, options);
                    });
            });
        }
        {% endfor %}
    {% endfor %}
});

// Función para detectar iOS
function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
}

// Manejar visualización de PDFs en modales
document.addEventListener("DOMContentLoaded", function() {
    // Configurar todos los modales de PDF
    {% for nivel in niveles %}
        {% for e in nivel.espacios %}
            {% for a in e.actividades %}
                {% if a.archivo_informacion %}
                (function() {
                    var modalId = 'pdfModal{{ forloop.counter }}';
                    var modal = document.getElementById(modalId);
                    if (modal) {
                        modal.addEventListener('show.bs.modal', function() {
                            var container = document.getElementById('pdf-container-{{ forloop.counter }}');
                            var iosMessage = document.getElementById('ios-message-{{ forloop.counter }}');
                            
                            if (isIOS()) {
                                // En iOS, mostrar mensaje alternativo
                                if (container) container.style.display = 'none';
                                if (iosMessage) iosMessage.classList.remove('d-none');
                            } else {
                                // En otros dispositivos, mostrar iframe
                                if (container) container.style.display = 'block';
                                if (iosMessage) iosMessage.classList.add('d-none');
                            }
                        });
                    }
                })();
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
});

// Corregir barras de progreso de niveles
document.addEventListener("DOMContentLoaded", function() {
    {% for nivel in niveles %}
    (function() {
        var bar = document.querySelector('.nivel-progress-bar-{{ nivel.id }}');
        if (bar) {
            var avanceStr = bar.getAttribute('data-avance');
            var avance = parseFloat(avanceStr.replace(',', '.'));
            if (!isNaN(avance)) {
                bar.style.width = avance + '%';
            }
        }
    })();
    {% endfor %}
});
</script>


{% endblock %}