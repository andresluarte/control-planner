{% extends 'construccion1app/base.html' %}

{% block contenido %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Mis Proyectos</h1>
    {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' %}
    <a href="{% url 'agregar_proyecto' %}" class="btn btn-success btn-lg shadow-sm" title="Agregar Proyecto">
        <i class="bi bi-plus-circle"></i>
    </a>
    {% endif %}
</div>

<!-- Filtro exclusivo para superusuario -->
{% if request.user.is_superuser %}
<div class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end" id="filtroForm">
            <div class="col-md-10">
                <label for="empresa_buscar" class="form-label fw-bold">
                    <i class="bi bi-building me-2"></i>Buscar por nombre de Empresa
                </label>
                <input 
                    type="text" 
                    name="empresa_buscar" 
                    id="empresa_buscar" 
                    class="form-control form-control-lg" 
                    placeholder="Escribe el nombre de la empresa..."
                    value="{{ request.GET.empresa_buscar }}"
                    list="empresas_list"
                >
                <datalist id="empresas_list">
                    {% for empresa in empresas %}
                    <option value="{{ empresa.nombre }}">
                    {% endfor %}
                </datalist>
                <small class="text-muted">Escribe para buscar por coincidencias</small>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-search me-2"></i>Buscar
                </button>
            </div>
        </form>
        
        {% if request.GET.empresa_buscar %}
        <div class="mt-3">
            <a href="{% url 'mis_proyectos' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-2"></i>Limpiar filtro
            </a>
            <span class="ms-3 text-muted">
                Mostrando resultados para: <strong>{{ request.GET.empresa_buscar }}</strong>
            </span>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if proyectos_data %}
<div class="row g-4">
    {% for proyecto in proyectos_data %}
    <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm border-0 rounded-4 h-100">
            <div class="card-body d-flex flex-column">
                <!-- Badge de empresa para superusuario -->
                {% if request.user.is_superuser and proyecto.empresa %}
                <span class="badge bg-info mb-2 align-self-start">
                    <i class="bi bi-building me-1"></i>{{ proyecto.empresa.nombre }}
                </span>
                {% endif %}
                
                <h5 class="card-title">
                    <a href="{% url 'dashboard_proyecto' proyecto.id %}" class="text-decoration-none text-primary">
                        {{ proyecto.nombre }}
                    </a>
                </h5>
                {% if proyecto.rubro %}
                    <p class="card-text text-truncate">{{ proyecto.rubro }}</p>
                {% endif %}

                {% if proyecto.ubicacion %}
                    <p class="card-text text-truncate">{{ proyecto.ubicacion }}</p>
                {% endif %}

                {% if proyecto.descripcion %}
                    <p class="card-text text-truncate">{{ proyecto.descripcion }}</p>
                {% endif %}

                <div class="mt-auto">
                    <p class="mb-1"><strong>Inicio:</strong> {{ proyecto.fecha_inicio|date:"d/m/Y" }}</p>
                    <p class="mb-2"><strong>Fin:</strong> {{ proyecto.fecha_fin|date:"d/m/Y" }}</p>

                    <div class="progress-circle-container text-center mt-3 mb-3">
                        <canvas id="progress-{{ proyecto.id }}" width="150" height="150"></canvas>
                    </div>

                    <div class="d-flex justify-content-end">
                        {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' %}
                        <a href="{% url 'editar_visibilidad' proyecto.id %}" class="btn btn-outline-success btn-sm me-2" title="Ver/Ocultar usuarios">
                            <i class="bi bi-eye"></i>
                        </a>
                        {% endif %}
                        
                        {% if request.user.is_superuser or request.user.tipo_usuario == 'superadmin_empresa' or request.user.tipo_usuario == 'admin_empresa' or request.user.tipo_usuario == 'supervisor_constructor' or request.user.tipo_usuario == 'calidad' %}
                        <a href="{% url 'programacion_obra' proyecto.id %}" class="btn btn-outline-warning btn-sm" title="Programaci√≥n de Obra">
                            <i class="bi bi-calendar-check"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info text-center" role="alert">
    <i class="bi bi-info-circle me-2"></i>
    {% if empresa_seleccionada %}
        No hay proyectos para la empresa seleccionada.
    {% else %}
        No tienes proyectos a√∫n.
    {% endif %}
</div>
{% endif %}

<style>
    body { background-color: #f8f9fa; }
    .card { transition: transform 0.2s, box-shadow 0.2s; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .btn-success i { font-size: 1.5rem; }
    .text-truncate { max-height: 3rem; overflow: hidden; }
    .progress-circle-container { 
        display: flex; 
        justify-content: center; 
        align-items: center;
        min-height: 150px;
    }
    .progress-circle-container canvas {
        max-width: 150px;
        max-height: 150px;
    }
    .badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.6rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    {% for proyecto in proyectos_data %}
    (function() {
        const canvas = document.getElementById('progress-{{ proyecto.id }}');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        // üëá CORRECCI√ìN AQU√ç - Forzar formato correcto
        const avance = parseFloat("{{ proyecto.avance_total|stringformat:'f' }}".replace(',', '.')) || 0;
        const restante = Math.max(0, 100 - avance);

        console.log('Proyecto {{ proyecto.nombre }}: avance =', avance); // Para debug

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Avance', 'Restante'],
                datasets: [{
                    data: [avance, restante],
                    backgroundColor: ['#0d6efd', '#e9ecef'],
                    borderWidth: 0,
                    borderRadius: 0
                }]
            },
            options: {
                cutout: '75%',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { 
                        enabled: true,
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed.toFixed(2) + '%';
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: false
                }
            },
            plugins: [{
                id: 'centerText',
                beforeDraw: function(chart) {
                    const width = chart.width;
                    const height = chart.height;
                    const ctx = chart.ctx;
                    
                    ctx.save();
                    const fontSize = Math.floor(height / 6);
                    ctx.font = 'bold ' + fontSize + 'px Arial, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#000';
                    
                    const text = avance.toFixed(2) + '%';
                    const textX = width / 2;
                    const textY = height / 2;
                    
                    ctx.fillText(text, textX, textY);
                    ctx.restore();
                }
            }]
        });
    })();
    {% endfor %}
});
</script>
<!--
<button onclick="forzarRenovacionToken()" class="btn btn-warning">
    üîÑ Renovar Token FCM
</button>

<script>
async function forzarRenovacionToken() {
    try {
        // Limpiar localStorage
        localStorage.removeItem('fcm_token');
        
        console.log('üîÑ Solicitando nuevo token...');
        
        const token = await messaging.getToken({ 
            vapidKey: "BNZqmRn5MYNhaZ8FdYCsc_A7mLTI5NspzN6dd4Fm1kDo4Lg3ZaN7LBfbQgPPY7V-IatQAQlc8q3mkD1jXZ7IGis" 
        });
        
        console.log('‚úÖ Nuevo token:', token);
        
        const response = await fetch('/save-fcm-token/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ token: token })
        });
        
        const data = await response.json();
        console.log('Respuesta:', data);
        
        if (data.status === 'success') {
            localStorage.setItem('fcm_token', token);
            alert('‚úÖ Token renovado exitosamente');
        } else {
            alert('‚ùå Error: ' + data.message);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error al renovar token: ' + error.message);
    }
}
</script>
-->

{% endblock %}